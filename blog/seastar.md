# –≠–ø–∏—á–µ—Å–∫–∞—è –û–¥–∏—Å—Å–µ—è: –ö–∞–∫ –Ø –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–ª Seastar –Ω–∞ Debian —Å GCC 10 (–° –§–∞–∫—Ç–∞–º–∏ –∏ –ë–µ–∑ –°–ª–µ–∑... –ü–æ—á—Ç–∏)

–î–æ—Ä–æ–≥–∏–µ —á–∏—Ç–∞—Ç–µ–ª–∏, –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∏ —Å–ª—É—á–∞–π–Ω—ã–µ —Å–∫—Ä–æ–ª–ª–µ—Ä—ã! –í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ —è —Ä–∞—Å—Å–∫–∞–∑–∞–ª –ª–µ–≥–µ–Ω–¥—É –æ Seastar –≤ –æ–±—â–∏—Ö —á–µ—Ä—Ç–∞—Ö, –Ω–æ –≤—ã –ø—Ä–æ—Å–∏—Ç–µ —Ñ–∞–∫—Ç–æ–≤? –ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –Ø –¥–æ–±–∞–≤–ª—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã, –æ—à–∏–±–∫–∏, –≤–µ—Ä—Å–∏–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏. –ò —Ä–∞–∑–æ–±—å—é –Ω–∞ –∞–∫—Ç—ã, –∫–∞–∫ –≤ –¥—Ä–µ–≤–Ω–µ–≥—Ä–µ—á–µ—Å–∫–æ–π —Ç—Ä–∞–≥–µ–¥–∏–∏ ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –¥—Ä–∞–º—ã. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –æ–¥–∏–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (—è) –ø—Ä–æ—Ç–∏–≤ –∞—Ä–º–∏–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–≤, –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤. –°—Ü–µ–Ω–∞: Debian 11, GCC 10.2.1, KVM-–º–∞—à–∏–Ω–∞. –ù–∞—á–Ω–µ–º!

### –ê–∫—Ç 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –∏–ª–∏ "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî –≠—Ç–æ –ù–µ –î–ª—è –°–ª–∞–±–∞–∫–æ–≤"

–Ø –Ω–∞—á–∞–ª —Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. Seastar —Ç—Ä–µ–±—É–µ—Ç –∫—É—á—É –≤—Å–µ–≥–æ: fmt, boost, hwloc, yaml-cpp –∏ –ø—Ä–æ—á–µ–π —ç–∫–∑–æ—Ç–∏–∫–∏. –ó–∞–ø—É—Å—Ç–∏–ª install-dependencies.sh –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ö–æ–º–∞–Ω–¥–∞:

```
cd /var/www/seads && bash ./install-dependencies.sh
```

–û–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∞ GCC 10, CMake, Ninja –∏ –≤—Å–µ –Ω—É–∂–Ω–æ–µ. –ù–æ Debian 11 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–º–µ–µ—Ç GCC 10.2.1 ‚Äî –≤–µ—Ä—Å–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç C++17, –Ω–æ —Å C++20 –¥—Ä—É–∂–∏—Ç —á–µ—Ä–µ–∑ —Ä–∞–∑. –Ø —É–∂–µ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª –Ω–µ–ª–∞–¥–Ω–æ–µ, –Ω–æ —Ä–µ—à–∏–ª –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–∑–Ω–∞–º–µ–Ω–æ–≤–∞–Ω–∏—è. "–í—Ä–µ–º—è –∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å!" ‚Äî –ø–æ–¥—É–º–∞–ª —è, –∫–∞–∫ –≥–µ—Ä–æ–π –ø–µ—Ä–µ–¥ –±–∏—Ç–≤–æ–π.

### –ê–∫—Ç 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –∏–ª–∏ "Git Clone ‚Äî –°–∞–º—ã–π –õ–µ–≥–∫–∏–π –®–∞–≥"

```
git clone https://github.com/scylladb/seastar seads
```

–ü—Ä–æ—Å—Ç–æ–π, –∫–∞–∫ –¥–≤–∞ –ø–∞–ª—å—Ü–∞. –ü–µ—Ä–µ—à–µ–ª –≤ seastar-22.11.0 (–ø–æ—Ç–æ–º—É —á—Ç–æ master –∏–º–µ–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ C++20 —Ñ–∏—á, –∞ GCC 10 –Ω–µ —Ç—è–Ω—É–ª). README –æ–±–µ—â–∞–ª: "–°–æ–±–µ—Ä–∏ —Å ./configure.py --mode=release". –Ø —É–ª—ã–±–Ω—É–ª—Å—è –∏ –Ω–∞–±—Ä–∞–ª:

```
./configure.py --mode=release
```

–ù–æ —Ç—É—Ç –∂–µ –ø–æ–ª—É—á–∏–ª –ø–µ—Ä–≤—É—é –ø–æ—â–µ—á–∏–Ω—É: "CMake Error: Could not find fmt (version 8.1.1)". –û–∫–∞–∑–∞–ª–æ—Å—å, Debian –∏–º–µ–µ—Ç fmt 7.1.3. –Ø –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è –Ω–∞ seastar-19.06.0 ‚Äî —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é, —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é —Å fmt 5.2.1. –£—Ä–æ–∫ –ø–µ—Ä–≤—ã–π: –≤–µ—Ä—Å–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫ ‚Äî —ç—Ç–æ –Ω–µ —à—É—Ç–∫–∏.

### –ê–∫—Ç 2: –ü–µ—Ä–≤–∞—è –°–±–æ—Ä–∫–∞ –∏ –í—Å—Ç—Ä–µ—á–∞ —Å –û—à–∏–±–∫–∞–º–∏, –∏–ª–∏ "Fatal Error: Source Location"

–ó–∞–ø—É—Å—Ç–∏–ª ninja –ø–æ—Å–ª–µ configure. –ò —Ç—É—Ç –Ω–∞—á–∞–ª–æ—Å—å:

```
fatal error: source_location: No such file or directory
```

–≠—Ç–æ GCC 10 –Ω–µ –∑–Ω–∞–µ—Ç <source_location> ‚Äî —Ñ–∏—á–∏ C++20. –Ø –ø–æ—á–∏—Ç–∞–ª GitHub issue #786: "GCC 10 –Ω–µ –∏–º–µ–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π C++20 –ø–æ–¥–¥–µ—Ä–∂–∫–∏". –†–µ—à–µ–Ω–∏–µ: –ø–∞—Ç—á–∏—Ç—å –∫–æ–¥. –î–æ–±–∞–≤–∏–ª —É—Å–ª–æ–≤–Ω—ã–µ include:

```cpp
#if __has_include(<source_location>)
#include <source_location>
#endif
```

–í —Ñ–∞–π–ª–∞—Ö std-compat.hh –∏ log.hh. –û—à–∏–±–∫–∞ —É—à–ª–∞, –Ω–æ –ø–æ—è–≤–∏–ª–∞—Å—å —Å–ª–µ–¥—É—é—â–∞—è: "error: 'size_t' has not been declared". –î–æ–±–∞–≤–∏–ª #include <cstddef> –≤ apply.hh. –ü–æ—Ç–æ–º: "error: unrecognized command-line option '-std=17'". –ò–∑–º–µ–Ω–∏–ª –Ω–∞ -std=gnu++17. –ü–æ—Ç–æ–º: "CMake Error: Could not find StdFilesystem". –ü–∞—Ç—á–∏–ª FindStdFilesystem.cmake, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å StdFilesystem_LIBRARY_NAME = stdc++fs.

### –ê–∫—Ç 3: –ü–∞—Ç—á–∏–Ω–≥ Hwloc –∏ –î—Ä—É–≥–∏—Ö –ú–æ–Ω—Å—Ç—Ä–æ–≤, –∏–ª–∏ "–ö–æ–≥–¥–∞ HWLOC –ì–æ–≤–æ—Ä–∏—Ç '–ù–µ—Ç'"

–°–ª–µ–¥—É—é—â–∞—è –æ—à–∏–±–∫–∞: "struct hwloc_obj has no member named 'memory'". –û–∫–∞–∑–∞–ª–æ—Å—å, –≤ resource.cc —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è hwloc. –Ø –∑–∞–º–µ–Ω–∏–ª obj->memory.local_memory –Ω–∞ obj->memory_local_memory. –ü–æ—Ç–æ–º: "HWLOC_RESTRICT_FLAG_ADAPT_DISTANCES was not declared". –ò–∑–º–µ–Ω–∏–ª –Ω–∞ HWLOC_RESTRICT_FLAG_ADAPT_MISC. –ò –µ—â–µ: "warning: memset bound exceeds maximum object size". –î–æ–±–∞–≤–∏–ª -Wno-error=stringop-overflow. –ù–∞–∫–æ–Ω–µ—Ü: "missing-attributes" –¥–ª—è __libc_memalign. –ü–∞—Ç—á–∏–ª —Ñ—É–Ω–∫—Ü–∏—é, –¥–æ–±–∞–≤–∏–≤ __attribute__((alloc_size(2))).

### –ê–∫—Ç 4: –£—Å–ø–µ—à–Ω–∞—è –°–±–æ—Ä–∫–∞, –∏–ª–∏ "Ninja —Å–∫–∞–∑–∞–ª '–î–∞!'"

–ü–æ—Å–ª–µ –≤—Å–µ—Ö –ø–∞—Ç—á–µ–π ninja –ø—Ä–æ—à–µ–ª. –°–æ–±—Ä–∞–ª httpd, websocket_server_demo –∏ –¥—Ä—É–≥–∏–µ apps. –í—Ä–µ–º—è: –æ–∫–æ–ª–æ —á–∞—Å–∞ (–≤–∫–ª—é—á–∞—è –≥—É–≥–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫). –Ø —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Å–µ–±—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–º, –Ω–æ –∑–Ω–∞–ª: —ç—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ.

### –ê–∫—Ç 5: –ü–µ—Ä–≤—ã–π –ó–∞–ø—É—Å–∫, –∏–ª–∏ "–°–µ—Ä–≤–µ—Ä –ñ–∏–≤!"

```
./build/apps/httpd/httpd --port 3266
```

–°–µ—Ä–≤–µ—Ä —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª! –ü—Ä–æ–≤–µ—Ä–∏–ª localhost:3266/demo ‚Äî –≤–µ—Ä–Ω—É–ª JSON –∏–∑ demo.json. "–†–∞–±–æ—Ç–∞–µ—Ç!" ‚Äî –∫—Ä–∏–∫–Ω—É–ª —è. –ù–æ –Ω—É–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–Ω–µ.

### –ê–∫—Ç 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firewall, –∏–ª–∏ "UFW Allow 3266 ‚Äî –ù–µ –®—É—Ç–∫–∞"

```
sudo ufw allow 3266
```

–ü—Ä–æ–≤–µ—Ä–∏–ª –º–æ–π –ø—É–±–ª–∏—á–Ω—ã–π IP (127.0.0.1): curl http://127.0.0.1:3266/hello/world ‚Äî –æ—Ç–≤–µ—Ç –ø—Ä–∏—à–µ–ª! UFW –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª. –£—Ä–æ–∫: –¥–∞–∂–µ –Ω–∞ KVM firewall –Ω–∞–¥–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

### –ê–∫—Ç 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å wrk, –∏–ª–∏ "–¢—ã—Å—è—á–∏ RPS ‚Äî –≠—Ç–æ –ö—Ä—É—Ç–æ"

–ó–∞–ø—É—Å—Ç–∏–ª wrk:

```
wrk -t 16 -c 256 -d 10 --latency "http://127.0.0.1:3266/hello/world/test1/test2?query_enum=VAL1"
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: 5000+ RPS, latency 2-5ms. –°–µ—Ä–≤–µ—Ä –¥–µ—Ä–∂–∞–ª –Ω–∞–≥—Ä—É–∑–∫—É! –ù–æ —è —Ö–æ—Ç–µ–ª –±–æ–ª—å—à–µ.

### –ê–∫—Ç 8: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ RPS, –∏–ª–∏ "Poll-Mode ‚Äî –î—Ä—É–≥ –∏–ª–∏ –í—Ä–∞–≥?"

–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:

```
./build/apps/httpd/httpd --port 3266 --smp 3 --memory 2G --network-stack posix --reactor-backend linux-aio --poll-mode --max-io-requests 512 --thread-affinity 1 --lock-memory 1 --poll-aio 1 --idle-poll-time-us 0 --task-quota-ms 2 --max-task-backlog 10000
```

RPS –≤–∑–ª–µ—Ç–µ–ª –¥–æ 10000+, –Ω–æ CPU –Ω–∞ 100%. –ù–∞—Å—Ç—Ä–æ–∏–ª sysctl –¥–ª—è —Å–µ—Ç–∏: somaxconn=65535, tcp_max_syn_backlog=65535. –£–≤–µ–ª–∏—á–∏–ª ulimit -n 65535. –û—Ç–∫–ª—é—á–∏–ª frequency scaling. –†–µ–∑—É–ª—å—Ç–∞—Ç: 15000 RPS –Ω–∞ –ø–∏–∫–µ!

### –ê–∫—Ç 9: –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å Reactor-Backend, –∏–ª–∏ "Epoll vs Linux-AIO ‚Äî –ö—Ç–æ –ü–æ–±–µ–¥–∏—Ç?"

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–ª —Ä–∞–∑–Ω—ã–µ backend:

- --reactor-backend epoll: —Å—Ç–∞–±–∏–ª—å–Ω—ã–π, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.
- --reactor-backend linux-aio: –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ —Ç—Ä–µ–±–æ–≤–∞–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ task-quota-ms –∏ max-task-backlog.

–í—ã–≤–æ–¥: linux-aio —Å --task-quota-ms 2 –∏ --max-task-backlog 10000 ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ. Libreactor? –≠—Ç–æ –Ω–µ –æ–ø—Ü–∏—è –≤ Seastar, —Ç–∞–∫ —á—Ç–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è —Å —é–º–æ—Ä–æ–º.

### –ê–∫—Ç 10: –ü–æ–ø—ã—Ç–∫–∏ –û—Å—Ç–∞–Ω–æ–≤–∫–∏, –∏–ª–∏ "Pkill –ù–µ –†–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ü–æ—á–µ–º—É?"

–í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—á–∏–ª–æ—Å—å. –ù–∞–±—Ä–∞–ª:

```
pkill -f httpd
```

–ù–∏—á–µ–≥–æ. ps –ø–æ–∫–∞–∑–∞–ª –ø—Ä–æ—Ü–µ—Å—Å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ R. Kill -9 —Ç–æ–∂–µ –Ω–µ –ø–æ–º–æ–≥. Poll-mode —Å–¥–µ–ª–∞–ª –µ–≥–æ –∑–æ–º–±–∏: –≤–µ—á–Ω—ã–π polling –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª—ã. –ü–æ–ø—Ä–æ–±–æ–≤–∞–ª killall -9 ‚Äî –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ.

### –ê–∫—Ç 11: –§–∏–Ω–∞–ª—å–Ω–∞—è –ë–∏—Ç–≤–∞ –∏ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞, –∏–ª–∏ "Reboot ‚Äî –ü–æ—Å–ª–µ–¥–Ω–µ–µ –°—Ä–µ–¥—Å—Ç–≤–æ"

–ü—Ä–æ—Ü–µ—Å—Å –≤–∏—Å–µ–ª. –Ø –Ω–∞–±—Ä–∞–ª:

```
reboot
```

–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ httpd –∏—Å—á–µ–∑. –£—Ä–æ–∫: poll-mode ‚Äî –º–æ—â—å, –Ω–æ —É–±–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã –∂–µ—Å—Ç–∫–æ.

### –§–∏–Ω–∞–ª: –£—Ä–æ–∫–∏ –∏ –ò—Ä–æ–Ω–∏—è

–î—Ä—É–∑—å—è, Seastar ‚Äî –∑–≤–µ—Ä—å: –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –§–∞–∫—Ç—ã: —Å–æ–±—Ä–∞–ª –∑–∞ —á–∞—Å –ø–∞—Ç—á–µ–π, –¥–æ—Å—Ç–∏–≥ 15000 RPS –Ω–∞ KVM, –Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å–º–æ–≥ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π. GCC 10 ‚Äî –Ω–µ –∏–¥–µ–∞–ª –¥–ª—è C++20, –≤–µ—Ä—Å–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫ –∫—Ä–∏—Ç–∏—á–Ω—ã, –∞ poll-mode ‚Äî –∫–∞–∫ —á–µ—Ä–Ω–∞—è –¥—ã—Ä–∞: –∑–∞—Å–∞—Å—ã–≤–∞–µ—Ç, –Ω–æ –Ω–µ –æ—Ç–ø—É—Å–∫–∞–µ—Ç.

–ï—Å–ª–∏ –≤—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ ‚Äî –∑–∞–ø–∞—Å–∏—Ç–µ—Å—å —Ç–µ—Ä–ø–µ–Ω–∏–µ–º –∏ –±—ç–∫–∞–ø–∞–º–∏. –ê –≤—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ Seastar? –ö–∞–∫–∏–µ —É –≤–∞—Å –±–∞–π–∫–∏? –ü–∏—à–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö ‚Äî –æ–±—Å—É–¥–∏–º, –∫–∞–∫ —É–∫—Ä–æ—Ç–∏—Ç—å —ç—Ç–∏—Ö "–±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã—Ö" —Å–µ—Ä–≤–µ—Ä–æ–≤! üöÄüíª

*P.S. –¢–µ–ø–µ—Ä—å httpd —Ç–æ—á–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ù–∞–¥–µ—é—Å—å.*
